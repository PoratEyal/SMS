const mongoose = require('mongoose');
const Week = require('./week');
const User = require('./user');
const ShiftData = require('./shiftData');

// ... (other route handlers and configurations)

workerRouter.put('/addWorkerToWorkrs', (req, res) => {
  const body = req.body;
  const managerId = body.managerId;
  const dayId = body.dayId;
  const shiftId = body.shiftId;
  const workerId = body.workerId;

  // Find the Week that matches the criteria to update the worker in the shifts
  Week.findOneAndUpdate(
    { "day._id": dayId, "day.shifts._id": shiftId, ofManager: managerId },
    {
      $push: { "day.$.shifts.$[shiftElem].workers": workerId },
    },
    { arrayFilters: [{ "shiftElem._id": shiftId }], projection: { "day.$": 1 } }
  )
    .then(() => {
      // Create a new ShiftData entry and add it to the shiftData array
      const newShiftData = new ShiftData({
        shiftId: shiftId,
        userId: workerId,
        start: new Date(), // Set the start time to the current date/time
        end: null, // Assuming the end time is initially null or not yet specified
      });

      newShiftData.save()
        .then(savedShiftData => {
          // Find the Week and update the shiftData array with the newly created ShiftData
          Week.findOneAndUpdate(
            { "day._id": dayId, "day.shifts._id": shiftId, ofManager: managerId },
            {
              $push: { "day.$.shifts.$[shiftElem].shiftData": savedShiftData },
              
            },
            { arrayFilters: [{ "shiftElem._id": shiftId }], projection: { "day.$": 1 } }
          )
            .then(updatedWeek => {
              res.status(200).json(updatedWeek.day[0]);
            })
            .catch((err) => {
              console.log(err);
              res.status(500).json({ error: "An error occurred while updating the shiftData array." });
            });
        })
        .catch((err) => {
          console.log(err);
          res.status(500).json({ error: "An error occurred while creating and saving ShiftData." });
        });
    })
    .catch((err) => {
      console.log(err);
      res.status(500).json({ error: "An error occurred while adding the worker shift." });
    });
});

// ... (other route handlers and configurations)

